<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre-Account Takeover CTF Lab | 0days Security</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel Standalone for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;
        const { Lock, Mail, CreditCard, DollarSign, Flag, AlertCircle, CheckCircle, XCircle } = lucide;

        function PreAccountTakeoverCTF() {
          const [currentView, setCurrentView] = useState('intro');
          const [accounts, setAccounts] = useState({});
          const [currentUser, setCurrentUser] = useState(null);
          const [exploitSteps, setExploitSteps] = useState([]);
          const [ctfComplete, setCtfComplete] = useState(false);
          const [signupEmail, setSignupEmail] = useState('');
          const [signupPassword, setSignupPassword] = useState('');
          const [loginEmail, setLoginEmail] = useState('');
          const [loginPassword, setLoginPassword] = useState('');
          const [cardNumber, setCardNumber] = useState('');
          const [cvv, setCvv] = useState('');

          // Victim's actual email (simulated)
          const VICTIM_EMAIL = 'alice.smith@company.com';
          const FLAG = 'CTF{pr3_4cc0unt_t4k30v3r_1s_d4ng3r0us}';

          const addExploitStep = (step, success) => {
            setExploitSteps(prev => [...prev, { step, success, timestamp: Date.now() }]);
          };

          const handleEmailPasswordSignup = (e) => {
            e.preventDefault();
            const email = signupEmail.toLowerCase();
            const password = signupPassword;

            if (accounts[email]) {
              alert('Account already exists!');
              return;
            }

            // VULNERABILITY: Creating account without email verification
            accounts[email] = {
              email,
              password,
              method: 'email',
              verified: false,
              balance: 0,
              cards: [],
              createdBy: 'attacker'
            };
            setAccounts({...accounts});
            
            if (email === VICTIM_EMAIL) {
              addExploitStep('Created pre-account with victim email', true);
              alert(`Account created! Note: Email verification email sent to ${email}`);
            } else {
              alert('Account created successfully!');
            }
            
            setSignupEmail('');
            setSignupPassword('');
          };

          const handleEmailPasswordLogin = (e) => {
            e.preventDefault();
            const email = loginEmail.toLowerCase();
            const password = loginPassword;

            const account = accounts[email];
            if (!account || account.password !== password) {
              alert('Invalid credentials!');
              return;
            }

            setCurrentUser(account);
            setCurrentView('dashboard');
            setLoginEmail('');
            setLoginPassword('');
          };

          const handleOAuthLogin = (provider) => {
            // Simulate OAuth flow - in real OAuth, this would redirect to Google/etc
            const email = prompt(`${provider} Login - Enter your ${provider} email:`);
            if (!email) return;

            const normalizedEmail = email.toLowerCase();

            // VULNERABILITY: Auto-login to existing account without verification
            if (accounts[normalizedEmail]) {
              // Just log them in - no verification that OAuth user owns this account!
              setCurrentUser(accounts[normalizedEmail]);
              setCurrentView('dashboard');
              
              if (normalizedEmail === VICTIM_EMAIL && accounts[normalizedEmail].createdBy === 'attacker') {
                addExploitStep('Victim logged into attacker-controlled account via OAuth', true);
              }
            } else {
              // Create new OAuth account
              accounts[normalizedEmail] = {
                email: normalizedEmail,
                method: 'oauth',
                provider,
                verified: true,
                balance: 0,
                cards: [],
                createdBy: 'victim'
              };
              setAccounts({...accounts});
              setCurrentUser(accounts[normalizedEmail]);
              setCurrentView('dashboard');
            }
          };

          const addPaymentMethod = (e) => {
            e.preventDefault();
            const card = cardNumber;
            const cardCvv = cvv;

            if (!card || !cardCvv) {
              alert('Please fill in all fields');
              return;
            }

            currentUser.cards.push({ cardNumber: card, cvv: cardCvv, addedAt: Date.now() });
            setAccounts({...accounts});
            
            if (currentUser.email === VICTIM_EMAIL && currentUser.createdBy === 'attacker') {
              addExploitStep('Victim added payment details to compromised account', true);
            }
            
            alert('Payment method added successfully!');
            setCardNumber('');
            setCvv('');
          };

          const addFunds = (amount) => {
            currentUser.balance += amount;
            setAccounts({...accounts});
            
            if (currentUser.email === VICTIM_EMAIL && currentUser.createdBy === 'attacker') {
              addExploitStep('Victim added funds to compromised account', true);
            }
          };

          const checkForFlag = () => {
            // Check if attacker successfully exploited the vulnerability
            const victimAccount = accounts[VICTIM_EMAIL];
            if (victimAccount && 
                victimAccount.createdBy === 'attacker' && 
                (victimAccount.cards.length > 0 || victimAccount.balance > 0)) {
              setCtfComplete(true);
              return true;
            }
            return false;
          };

          const attemptExploit = () => {
            if (checkForFlag()) {
              alert(`üéâ CTF COMPLETE!\n\nFlag: ${FLAG}\n\nYou successfully:\n1. Pre-registered victim's email\n2. Victim logged in via OAuth\n3. Captured sensitive data from victim's usage`);
            } else {
              alert('Exploit not complete yet. Follow the steps:\n1. Sign up with victim email\n2. Have victim login with OAuth\n3. Victim adds payment info');
            }
          };

          const logout = () => {
            setCurrentUser(null);
            setCurrentView('login');
          };

          if (currentView === 'intro') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white p-8">
                <div className="max-w-4xl mx-auto">
                  <div className="bg-slate-800 rounded-lg p-8 shadow-2xl border border-purple-500">
                    <div className="flex items-center gap-3 mb-6">
                      <Flag className="w-8 h-8 text-purple-400" />
                      <h1 className="text-3xl font-bold">Pre-Account Takeover CTF</h1>
                    </div>
                    
                    <div className="space-y-6">
                      <div className="bg-slate-700 p-6 rounded-lg">
                        <h2 className="text-xl font-bold mb-4 text-purple-300">üéØ Challenge Objective</h2>
                        <p className="mb-4">
                          You've discovered that SecureBank's authentication system has a critical vulnerability. 
                          Your target is Alice Smith (alice.smith@company.com), a high-value customer who will 
                          soon sign up using "Sign in with Google".
                        </p>
                        <p className="font-bold text-yellow-300">
                          Exploit the pre-account takeover vulnerability to capture the flag!
                        </p>
                      </div>

                      <div className="bg-slate-700 p-6 rounded-lg">
                        <h2 className="text-xl font-bold mb-4 text-purple-300">üîç Vulnerability Details</h2>
                        <p className="mb-3">
                          SecureBank supports both email/password and OAuth authentication. The vulnerability exists because:
                        </p>
                        <ul className="list-disc list-inside space-y-2 text-gray-300">
                          <li>Email addresses are the primary account identifier</li>
                          <li>Email/password accounts don't require email verification</li>
                          <li>OAuth login auto-merges with existing accounts without ownership verification</li>
                          <li>No confirmation prompt when OAuth email matches existing account</li>
                        </ul>
                      </div>

                      <div className="bg-slate-700 p-6 rounded-lg">
                        <h2 className="text-xl font-bold mb-4 text-purple-300">üìã Exploitation Steps</h2>
                        <ol className="list-decimal list-inside space-y-2 text-gray-300">
                          <li>Create an account using Alice's email (alice.smith@company.com) with a password you control</li>
                          <li>Simulate Alice logging in via "Sign in with Google" using her email</li>
                          <li>As Alice, add payment information or funds to the account</li>
                          <li>Log back in as the attacker to access Alice's data and retrieve the flag</li>
                        </ol>
                      </div>

                      <div className="bg-yellow-900 border border-yellow-600 p-4 rounded-lg">
                        <p className="text-sm text-yellow-100">
                          <strong>‚ö†Ô∏è Educational Purpose:</strong> This lab demonstrates a real vulnerability found in production 
                          applications. Never test for vulnerabilities on systems you don't own or have permission to test.
                        </p>
                      </div>

                      <button
                        onClick={() => setCurrentView('login')}
                        className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition"
                      >
                        Start Challenge ‚Üí
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          if (currentView === 'dashboard') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-900 to-slate-900 text-white p-8">
                <div className="max-w-6xl mx-auto">
                  <div className="bg-slate-800 rounded-lg p-8 shadow-2xl">
                    <div className="flex justify-between items-center mb-6">
                      <h1 className="text-3xl font-bold">SecureBank Dashboard</h1>
                      <button
                        onClick={logout}
                        className="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg"
                      >
                        Logout
                      </button>
                    </div>

                    <div className="bg-slate-700 p-4 rounded-lg mb-6">
                      <p className="text-sm text-gray-300">Logged in as:</p>
                      <p className="text-xl font-bold">{currentUser.email}</p>
                      <p className="text-sm text-gray-400">
                        Auth Method: {currentUser.method === 'oauth' ? `OAuth (${currentUser.provider})` : 'Email/Password'}
                        {currentUser.createdBy === 'attacker' && <span className="ml-2 text-red-400">‚ö†Ô∏è Compromised</span>}
                      </p>
                    </div>

                    <div className="grid md:grid-cols-2 gap-6 mb-6">
                      <div className="bg-gradient-to-br from-green-600 to-green-700 p-6 rounded-lg">
                        <DollarSign className="w-8 h-8 mb-2" />
                        <p className="text-sm opacity-80">Account Balance</p>
                        <p className="text-3xl font-bold">${currentUser.balance.toFixed(2)}</p>
                        <div className="mt-4 space-x-2">
                          <button
                            onClick={() => addFunds(100)}
                            className="bg-white text-green-700 px-3 py-1 rounded text-sm font-bold"
                          >
                            +$100
                          </button>
                          <button
                            onClick={() => addFunds(1000)}
                            className="bg-white text-green-700 px-3 py-1 rounded text-sm font-bold"
                          >
                            +$1000
                          </button>
                        </div>
                      </div>

                      <div className="bg-gradient-to-br from-purple-600 to-purple-700 p-6 rounded-lg">
                        <CreditCard className="w-8 h-8 mb-2" />
                        <p className="text-sm opacity-80">Payment Methods</p>
                        <p className="text-3xl font-bold">{currentUser.cards.length}</p>
                        <p className="text-sm mt-2">{currentUser.cards.length === 0 ? 'No cards added' : 'Cards on file'}</p>
                      </div>
                    </div>

                    <div className="bg-slate-700 p-6 rounded-lg mb-6">
                      <h2 className="text-xl font-bold mb-4">Add Payment Method</h2>
                      <div className="space-y-4">
                        <input
                          type="text"
                          value={cardNumber}
                          onChange={(e) => setCardNumber(e.target.value)}
                          placeholder="Card Number (e.g., 4532-1234-5678-9010)"
                          className="w-full px-4 py-2 bg-slate-600 rounded-lg text-white"
                        />
                        <input
                          type="text"
                          value={cvv}
                          onChange={(e) => setCvv(e.target.value)}
                          placeholder="CVV"
                          maxLength={3}
                          className="w-full px-4 py-2 bg-slate-600 rounded-lg text-white"
                        />
                        <button
                          onClick={addPaymentMethod}
                          className="w-full bg-purple-600 hover:bg-purple-700 py-2 rounded-lg font-bold"
                        >
                          Add Card
                        </button>
                      </div>
                    </div>

                    {currentUser.cards.length > 0 && (
                      <div className="bg-slate-700 p-6 rounded-lg">
                        <h2 className="text-xl font-bold mb-4">Saved Payment Methods</h2>
                        {currentUser.cards.map((card, idx) => (
                          <div key={idx} className="bg-slate-600 p-4 rounded-lg mb-2">
                            <p className="font-mono">Card: **** **** **** {card.cardNumber.slice(-4)}</p>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 text-white p-8">
              <div className="max-w-6xl mx-auto">
                <div className="grid md:grid-cols-3 gap-6">
                  {/* Main Auth Panel */}
                  <div className="md:col-span-2 bg-slate-800 rounded-lg p-8 shadow-2xl">
                    <h1 className="text-3xl font-bold mb-6">üè¶ SecureBank</h1>
                    
                    <div className="bg-slate-700 p-6 rounded-lg mb-6">
                      <h2 className="text-2xl font-bold mb-4">Create Account</h2>
                      <div className="space-y-4">
                        <div>
                          <label className="block text-sm mb-2">Email</label>
                          <input
                            type="email"
                            value={signupEmail}
                            onChange={(e) => setSignupEmail(e.target.value)}
                            placeholder="your.email@example.com"
                            className="w-full px-4 py-2 bg-slate-600 rounded-lg text-white"
                          />
                        </div>
                        <div>
                          <label className="block text-sm mb-2">Password</label>
                          <input
                            type="password"
                            value={signupPassword}
                            onChange={(e) => setSignupPassword(e.target.value)}
                            placeholder="Enter password"
                            className="w-full px-4 py-2 bg-slate-600 rounded-lg text-white"
                          />
                        </div>
                        <button
                          onClick={handleEmailPasswordSignup}
                          className="w-full bg-blue-600 hover:bg-blue-700 py-2 rounded-lg font-bold"
                        >
                          Sign Up
                        </button>
                      </div>
                    </div>

                    <div className="bg-slate-700 p-6 rounded-lg mb-6">
                      <h2 className="text-2xl font-bold mb-4">Login</h2>
                      <div className="space-y-4 mb-4">
                        <input
                          type="email"
                          value={loginEmail}
                          onChange={(e) => setLoginEmail(e.target.value)}
                          placeholder="Email"
                          className="w-full px-4 py-2 bg-slate-600 rounded-lg text-white"
                        />
                        <input
                          type="password"
                          value={loginPassword}
                          onChange={(e) => setLoginPassword(e.target.value)}
                          placeholder="Password"
                          className="w-full px-4 py-2 bg-slate-600 rounded-lg text-white"
                        />
                        <button
                          onClick={handleEmailPasswordLogin}
                          className="w-full bg-green-600 hover:bg-green-700 py-2 rounded-lg font-bold"
                        >
                          Login
                        </button>
                      </div>

                      <div className="relative my-6">
                        <div className="absolute inset-0 flex items-center">
                          <div className="w-full border-t border-slate-600"></div>
                        </div>
                        <div className="relative flex justify-center text-sm">
                          <span className="px-2 bg-slate-700 text-gray-400">OR</span>
                        </div>
                      </div>

                      <div className="space-y-3">
                        <button
                          onClick={() => handleOAuthLogin('Google')}
                          className="w-full bg-white text-gray-800 py-2 rounded-lg font-bold hover:bg-gray-100"
                        >
                          üîê Sign in with Google
                        </button>
                        <button
                          onClick={() => handleOAuthLogin('GitHub')}
                          className="w-full bg-gray-800 text-white py-2 rounded-lg font-bold hover:bg-gray-700 border border-gray-600"
                        >
                          üîê Sign in with GitHub
                        </button>
                      </div>
                    </div>
                  </div>

                  {/* Exploit Tracker Panel */}
                  <div className="bg-slate-800 rounded-lg p-6 shadow-2xl">
                    <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                      <Flag className="w-5 h-5 text-yellow-400" />
                      Exploit Tracker
                    </h2>

                    {exploitSteps.length === 0 ? (
                      <div className="text-gray-400 text-sm">
                        <p>No steps completed yet.</p>
                        <p className="mt-2">Start by creating an account with the victim's email!</p>
                      </div>
                    ) : (
                      <div className="space-y-2 mb-4">
                        {exploitSteps.map((step, idx) => (
                          <div key={idx} className="flex items-start gap-2 text-sm">
                            {step.success ? (
                              <CheckCircle className="w-4 h-4 text-green-400 mt-0.5 flex-shrink-0" />
                            ) : (
                              <XCircle className="w-4 h-4 text-red-400 mt-0.5 flex-shrink-0" />
                            )}
                            <span className="text-gray-300">{step.step}</span>
                          </div>
                        ))}
                      </div>
                    )}

                    <button
                      onClick={attemptExploit}
                      className={`w-full py-2 rounded-lg font-bold transition ${
                        ctfComplete
                          ? 'bg-green-600 hover:bg-green-700'
                          : 'bg-purple-600 hover:bg-purple-700'
                      }`}
                    >
                      {ctfComplete ? 'üéâ View Flag' : 'üö© Capture Flag'}
                    </button>

                    <div className="mt-6 bg-slate-700 p-4 rounded-lg text-xs">
                      <p className="font-bold mb-2 text-yellow-300">üí° Hint:</p>
                      <p className="text-gray-300">
                        Victim email: <span className="font-mono text-purple-300">{VICTIM_EMAIL}</span>
                      </p>
                      <p className="text-gray-400 mt-2">
                        The victim will login using OAuth. Set up your pre-account first!
                      </p>
                    </div>

                    {Object.keys(accounts).length > 0 && (
                      <div className="mt-4 bg-slate-700 p-4 rounded-lg text-xs">
                        <p className="font-bold mb-2">Debug: Accounts</p>
                        {Object.values(accounts).map((acc, idx) => (
                          <div key={idx} className="text-gray-400 mb-1">
                            {acc.email} ({acc.createdBy})
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>
          );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PreAccountTakeoverCTF />);

        // Initialize Lucide icons
        lucide.createIcons();
    </script>
</body>
</html>
