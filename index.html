<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre-Account Takeover CTF Lab | 0days Security</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        // Simple icons as SVG strings
        const icons = {
            flag: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></svg>`,
            check: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>`,
            x: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`
        };

        // State
        let state = {
            currentView: 'intro',
            accounts: {},
            currentUser: null,
            exploitSteps: [],
            ctfComplete: false,
            signupEmail: '',
            signupPassword: '',
            loginEmail: '',
            loginPassword: '',
            cardNumber: '',
            cvv: ''
        };

        const VICTIM_EMAIL = 'alice.smith@company.com';
        const FLAG = 'CTF{pr3_4cc0unt_t4k30v3r_1s_d4ng3r0us}';

        // Helper functions
        function addExploitStep(step, success) {
            state.exploitSteps.push({ step, success, timestamp: Date.now() });
            render();
        }

        function handleEmailPasswordSignup() {
            const email = state.signupEmail.toLowerCase().trim();
            const password = state.signupPassword;

            if (!email || !password) {
                alert('Please fill in all fields');
                return;
            }

            if (state.accounts[email]) {
                alert('Account already exists!');
                return;
            }

            state.accounts[email] = {
                email,
                password,
                method: 'email',
                verified: false,
                balance: 0,
                cards: [],
                createdBy: 'attacker'
            };
            
            if (email === VICTIM_EMAIL) {
                addExploitStep('Created pre-account with victim email', true);
                alert(`Account created! Note: Email verification email sent to ${email}`);
            } else {
                alert('Account created successfully!');
            }
            
            state.signupEmail = '';
            state.signupPassword = '';
            render();
        }

        function handleEmailPasswordLogin() {
            const email = state.loginEmail.toLowerCase().trim();
            const password = state.loginPassword;

            const account = state.accounts[email];
            if (!account || account.password !== password) {
                alert('Invalid credentials!');
                return;
            }

            state.currentUser = account;
            state.currentView = 'dashboard';
            state.loginEmail = '';
            state.loginPassword = '';
            render();
        }

        function handleOAuthLogin(provider) {
            const email = prompt(`${provider} Login - Enter your ${provider} email:`);
            if (!email) return;

            const normalizedEmail = email.toLowerCase().trim();

            if (state.accounts[normalizedEmail]) {
                state.currentUser = state.accounts[normalizedEmail];
                state.currentView = 'dashboard';
                
                if (normalizedEmail === VICTIM_EMAIL && state.accounts[normalizedEmail].createdBy === 'attacker') {
                    addExploitStep('Victim logged into attacker-controlled account via OAuth', true);
                }
            } else {
                state.accounts[normalizedEmail] = {
                    email: normalizedEmail,
                    method: 'oauth',
                    provider,
                    verified: true,
                    balance: 0,
                    cards: [],
                    createdBy: 'victim'
                };
                state.currentUser = state.accounts[normalizedEmail];
                state.currentView = 'dashboard';
            }
            render();
        }

        function addPaymentMethod() {
            if (!state.cardNumber || !state.cvv) {
                alert('Please fill in all fields');
                return;
            }

            state.currentUser.cards.push({ 
                cardNumber: state.cardNumber, 
                cvv: state.cvv, 
                addedAt: Date.now() 
            });
            
            if (state.currentUser.email === VICTIM_EMAIL && state.currentUser.createdBy === 'attacker') {
                addExploitStep('Victim added payment details to compromised account', true);
            }
            
            alert('Payment method added successfully!');
            state.cardNumber = '';
            state.cvv = '';
            render();
        }

        function addFunds(amount) {
            state.currentUser.balance += amount;
            
            if (state.currentUser.email === VICTIM_EMAIL && state.currentUser.createdBy === 'attacker') {
                addExploitStep('Victim added funds to compromised account', true);
            }
            render();
        }

        function checkForFlag() {
            const victimAccount = state.accounts[VICTIM_EMAIL];
            if (victimAccount && 
                victimAccount.createdBy === 'attacker' && 
                (victimAccount.cards.length > 0 || victimAccount.balance > 0)) {
                state.ctfComplete = true;
                return true;
            }
            return false;
        }

        function attemptExploit() {
            if (checkForFlag()) {
                alert(`üéâ CTF COMPLETE!\n\nFlag: ${FLAG}\n\nYou successfully:\n1. Pre-registered victim's email\n2. Victim logged in via OAuth\n3. Captured sensitive data from victim's usage`);
            } else {
                alert('Exploit not complete yet. Follow the steps:\n1. Sign up with victim email (alice.smith@company.com)\n2. Have victim login with OAuth\n3. Victim adds payment info');
            }
        }

        function logout() {
            state.currentUser = null;
            state.currentView = 'login';
            render();
        }

        // Render functions
        function renderIntro() {
            return `
                <div class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white p-8">
                    <div class="max-w-4xl mx-auto">
                        <div class="bg-slate-800 rounded-lg p-8 shadow-2xl border border-purple-500">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="text-purple-400">${icons.flag}</div>
                                <h1 class="text-3xl font-bold">Pre-Account Takeover CTF</h1>
                            </div>
                            
                            <div class="space-y-6">
                                <div class="bg-slate-700 p-6 rounded-lg">
                                    <h2 class="text-xl font-bold mb-4 text-purple-300">üéØ Challenge Objective</h2>
                                    <p class="mb-4">
                                        You've discovered that SecureBank's authentication system has a critical vulnerability. 
                                        Your target is Alice Smith (alice.smith@company.com), a high-value customer who will 
                                        soon sign up using "Sign in with Google".
                                    </p>
                                    <p class="font-bold text-yellow-300">
                                        Exploit the pre-account takeover vulnerability to capture the flag!
                                    </p>
                                </div>

                                <div class="bg-slate-700 p-6 rounded-lg">
                                    <h2 class="text-xl font-bold mb-4 text-purple-300">üîç Vulnerability Details</h2>
                                    <p class="mb-3">
                                        SecureBank supports both email/password and OAuth authentication. The vulnerability exists because:
                                    </p>
                                    <ul class="list-disc list-inside space-y-2 text-gray-300">
                                        <li>Email addresses are the primary account identifier</li>
                                        <li>Email/password accounts don't require email verification</li>
                                        <li>OAuth login auto-merges with existing accounts without ownership verification</li>
                                        <li>No confirmation prompt when OAuth email matches existing account</li>
                                    </ul>
                                </div>

                                <div class="bg-slate-700 p-6 rounded-lg">
                                    <h2 class="text-xl font-bold mb-4 text-purple-300">üìã Exploitation Steps</h2>
                                    <ol class="list-decimal list-inside space-y-2 text-gray-300">
                                        <li>Create an account using Alice's email (alice.smith@company.com) with a password you control</li>
                                        <li>Simulate Alice logging in via "Sign in with Google" using her email</li>
                                        <li>As Alice, add payment information or funds to the account</li>
                                        <li>Log back in as the attacker to access Alice's data and retrieve the flag</li>
                                    </ol>
                                </div>

                                <div class="bg-yellow-900 border border-yellow-600 p-4 rounded-lg">
                                    <p class="text-sm text-yellow-100">
                                        <strong>‚ö†Ô∏è Educational Purpose:</strong> This lab demonstrates a real vulnerability found in production 
                                        applications. Never test for vulnerabilities on systems you don't own or have permission to test.
                                    </p>
                                </div>

                                <button
                                    onclick="state.currentView = 'login'; render();"
                                    class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition cursor-pointer"
                                >
                                    Start Challenge ‚Üí
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            return `
                <div class="min-h-screen bg-gradient-to-br from-blue-900 to-slate-900 text-white p-8">
                    <div class="max-w-6xl mx-auto">
                        <div class="bg-slate-800 rounded-lg p-8 shadow-2xl">
                            <div class="flex justify-between items-center mb-6">
                                <h1 class="text-3xl font-bold">SecureBank Dashboard</h1>
                                <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg cursor-pointer">
                                    Logout
                                </button>
                            </div>

                            <div class="bg-slate-700 p-4 rounded-lg mb-6">
                                <p class="text-sm text-gray-300">Logged in as:</p>
                                <p class="text-xl font-bold">${state.currentUser.email}</p>
                                <p class="text-sm text-gray-400">
                                    Auth Method: ${state.currentUser.method === 'oauth' ? `OAuth (${state.currentUser.provider})` : 'Email/Password'}
                                    ${state.currentUser.createdBy === 'attacker' ? '<span class="ml-2 text-red-400">‚ö†Ô∏è Compromised</span>' : ''}
                                </p>
                            </div>

                            <div class="grid md:grid-cols-2 gap-6 mb-6">
                                <div class="bg-gradient-to-br from-green-600 to-green-700 p-6 rounded-lg">
                                    <p class="text-sm opacity-80">Account Balance</p>
                                    <p class="text-3xl font-bold">$${state.currentUser.balance.toFixed(2)}</p>
                                    <div class="mt-4 space-x-2">
                                        <button onclick="addFunds(100)" class="bg-white text-green-700 px-3 py-1 rounded text-sm font-bold cursor-pointer">
                                            +$100
                                        </button>
                                        <button onclick="addFunds(1000)" class="bg-white text-green-700 px-3 py-1 rounded text-sm font-bold cursor-pointer">
                                            +$1000
                                        </button>
                                    </div>
                                </div>

                                <div class="bg-gradient-to-br from-purple-600 to-purple-700 p-6 rounded-lg">
                                    <p class="text-sm opacity-80">Payment Methods</p>
                                    <p class="text-3xl font-bold">${state.currentUser.cards.length}</p>
                                    <p class="text-sm mt-2">${state.currentUser.cards.length === 0 ? 'No cards added' : 'Cards on file'}</p>
                                </div>
                            </div>

                            <div class="bg-slate-700 p-6 rounded-lg mb-6">
                                <h2 class="text-xl font-bold mb-4">Add Payment Method</h2>
                                <div class="space-y-4">
                                    <input
                                        type="text"
                                        value="${state.cardNumber}"
                                        oninput="state.cardNumber = this.value"
                                        placeholder="Card Number (e.g., 4532-1234-5678-9010)"
                                        class="w-full px-4 py-2 bg-slate-600 rounded-lg text-white"
                                    />
                                    <input
                                        type="text"
                                        value="${state.cvv}"
                                        oninput="state.cvv = this.value"
                                        placeholder="CVV"
                                        maxlength="3"
                                        class="w-full px-4 py-2 bg-slate-600 rounded-lg text-white"
                                    />
                                    <button
                                        onclick="addPaymentMethod()"
                                        class="w-full bg-purple-600 hover:bg-purple-700 py-2 rounded-lg font-bold cursor-pointer"
                                    >
                                        Add Card
                                    </button>
                                </div>
                            </div>

                            ${state.currentUser.cards.length > 0 ? `
                                <div class="bg-slate-700 p-6 rounded-lg">
                                    <h2 class="text-xl font-bold mb-4">Saved Payment Methods</h2>
                                    ${state.currentUser.cards.map(card => `
                                        <div class="bg-slate-600 p-4 rounded-lg mb-2">
                                            <p class="font-mono">Card: **** **** **** ${card.cardNumber.slice(-4)}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderLogin() {
            return `
                <div class="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 text-white p-8">
                    <div class="max-w-6xl mx-auto">
                        <div class="grid md:grid-cols-3 gap-6">
                            <div class="md:col-span-2 bg-slate-800 rounded-lg p-8 shadow-2xl">
                                <h1 class="text-3xl font-bold mb-6">üè¶ SecureBank</h1>
                                
                                <div class="bg-slate-700 p-6 rounded-lg mb-6">
                                    <h2 class="text-2xl font-bold mb-4">Create Account</h2>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm mb-2">Email</label>
                                            <input
                                                type="email"
                                                value="${state.signupEmail}"
                                                oninput="state.signupEmail = this.value"
                                                placeholder="your.email@example.com"
                                                class="w-full px-4 py-2 bg-slate-600 rounded-lg text-white"
                                            />
                                        </div>
                                        <div>
                                            <label class="block text-sm mb-2">Password</label>
                                            <input
                                                type="password"
                                                value="${state.signupPassword}"
                                                oninput="state.signupPassword = this.value"
                                                placeholder="Enter password"
                                                class="w-full px-4 py-2 bg-slate-600 rounded-lg text-white"
                                            />
                                        </div>
                                        <button
                                            onclick="handleEmailPasswordSignup()"
                                            class="w-full bg-blue-600 hover:bg-blue-700 py-2 rounded-lg font-bold cursor-pointer"
                                        >
                                            Sign Up
                                        </button>
                                    </div>
                                </div>

                                <div class="bg-slate-700 p-6 rounded-lg mb-6">
                                    <h2 class="text-2xl font-bold mb-4">Login</h2>
                                    <div class="space-y-4 mb-4">
                                        <input
                                            type="email"
                                            value="${state.loginEmail}"
                                            oninput="state.loginEmail = this.value"
                                            placeholder="Email"
                                            class="w-full px-4 py-2 bg-slate-600 rounded-lg text-white"
                                        />
                                        <input
                                            type="password"
                                            value="${state.loginPassword}"
                                            oninput="state.loginPassword = this.value"
                                            placeholder="Password"
                                            class="w-full px-4 py-2 bg-slate-600 rounded-lg text-white"
                                        />
                                        <button
                                            onclick="handleEmailPasswordLogin()"
                                            class="w-full bg-green-600 hover:bg-green-700 py-2 rounded-lg font-bold cursor-pointer"
                                        >
                                            Login
                                        </button>
                                    </div>

                                    <div class="relative my-6">
                                        <div class="absolute inset-0 flex items-center">
                                            <div class="w-full border-t border-slate-600"></div>
                                        </div>
                                        <div class="relative flex justify-center text-sm">
                                            <span class="px-2 bg-slate-700 text-gray-400">OR</span>
                                        </div>
                                    </div>

                                    <div class="space-y-3">
                                        <button
                                            onclick="handleOAuthLogin('Google')"
                                            class="w-full bg-white text-gray-800 py-2 rounded-lg font-bold hover:bg-gray-100 cursor-pointer"
                                        >
                                            üîê Sign in with Google
                                        </button>
                                        <button
                                            onclick="handleOAuthLogin('GitHub')"
                                            class="w-full bg-gray-800 text-white py-2 rounded-lg font-bold hover:bg-gray-700 border border-gray-600 cursor-pointer"
                                        >
                                            üîê Sign in with GitHub
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-slate-800 rounded-lg p-6 shadow-2xl">
                                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                                    <span class="text-yellow-400">${icons.flag}</span>
                                    Exploit Tracker
                                </h2>

                                ${state.exploitSteps.length === 0 ? `
                                    <div class="text-gray-400 text-sm">
                                        <p>No steps completed yet.</p>
                                        <p class="mt-2">Start by creating an account with the victim's email!</p>
                                    </div>
                                ` : `
                                    <div class="space-y-2 mb-4">
                                        ${state.exploitSteps.map(step => `
                                            <div class="flex items-start gap-2 text-sm">
                                                <span class="${step.success ? 'text-green-400' : 'text-red-400'}">${step.success ? icons.check : icons.x}</span>
                                                <span class="text-gray-300">${step.step}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}

                                <button
                                    onclick="attemptExploit()"
                                    class="w-full py-2 rounded-lg font-bold transition cursor-pointer ${
                                        state.ctfComplete ? 'bg-green-600 hover:bg-green-700' : 'bg-purple-600 hover:bg-purple-700'
                                    }"
                                >
                                    ${state.ctfComplete ? 'üéâ View Flag' : 'üö© Capture Flag'}
                                </button>

                                <div class="mt-6 bg-slate-700 p-4 rounded-lg text-xs">
                                    <p class="font-bold mb-2 text-yellow-300">üí° Hint:</p>
                                    <p class="text-gray-300">
                                        Victim email: <span class="font-mono text-purple-300">${VICTIM_EMAIL}</span>
                                    </p>
                                    <p class="text-gray-400 mt-2">
                                        The victim will login using OAuth. Set up your pre-account first!
                                    </p>
                                </div>

                                ${Object.keys(state.accounts).length > 0 ? `
                                    <div class="mt-4 bg-slate-700 p-4 rounded-lg text-xs">
                                        <p class="font-bold mb-2">Debug: Accounts</p>
                                        ${Object.values(state.accounts).map(acc => `
                                            <div class="text-gray-400 mb-1">${acc.email} (${acc.createdBy})</div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function render() {
            const root = document.getElementById('root');
            if (state.currentView === 'intro') {
                root.innerHTML = renderIntro();
            } else if (state.currentView === 'dashboard') {
                root.innerHTML = renderDashboard();
            } else {
                root.innerHTML = renderLogin();
            }
        }

        // Initial render
        render();
    </script>
</body>
</html>
